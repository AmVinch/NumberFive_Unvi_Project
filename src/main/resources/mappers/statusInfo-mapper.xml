<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<!--by수경 학생의 학사경고, 제적을 위한 stutusInfo mapper입니다.-->
<mapper namespace="statusInfoMapper">

<!-- by수경 stutusInfo resultMap -->
<resultMap type="kh.study.NF.emp.vo.StatusInfoVO" id="StatusInfo">
<id column="STATUS_NO" property="statusNo"/>
<result column="STU_NO" property="stuNo"/>
<result column="NOW_STATUS" property="nowStatus"/>
<result column="AFTER_STATUS" property="afterStatus"/>
<result column="APPLY_DATE" property="applyDate"/>
<result column="APPROVAL_DATE" property="approvalDate"/>
<result column="ING_STATUS" property="ingStatus"/>
<!-- by수경 1:1관계 (학사경고/제적) -->
<association property="academicProbationVO" resultMap="probation"/>
<association property="stuOutVO" resultMap="StuOut"/>
</resultMap>
	
<!--by수경 stuOut resultMap 학사경고 -->
<resultMap type="kh.study.NF.emp.vo.StuOutVO" id="StuOut">
<id column="STU_OUT_NO" property="stuOutNo"/>
<result column="STU_NO" property="stuNo"/>
<result column="STU_OUT_DATE" property="stuOutDate"/>
<result column="STU_OUT_REASON" property="stuOutReason"/>
</resultMap>

<!--by수경 academicProbation resultMap 제적 -->
<resultMap type="kh.study.NF.emp.vo.AcademicProbationVO" id="probation">
<id column="PROB_NO" property="probNo"/>
<result column="STU_NO" property="stuNo"/>
<result column="PROB_DATE" property="probDate"/>
<result column="PROB_REASON" property="probReason"/>
<result column="SEM_NO" property="semNo"/>
<result column="MEM_NO" property="memNo"/>
</resultMap>


<!--by수경 전체 학생 조회하기 -->
<select id="selectAllStu" resultMap="studentMapper.student">
	SELECT (SELECT MEM_NAME FROM MEMBER WHERE MEM_NO = S.MEM_NO) AS MEM_NAME
		 , STU_NO
		 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = S.COLL_NO) AS COLL_NO
		 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO = S.DEPT_NO) AS DEPT_NO
		 , STU_STATUS
		 , (SELECT STATUS_NO FROM STATUS_INFO WHERE STU_NO = S.STU_NO)AS STATUS_NO
	FROM STU S
	ORDER BY STU_NO DESC
</select>

<!--by수경 학사경고 모달창 학생 기본정보 데이터 출력 -->
<select id="probationStuInfo" resultMap="studentMapper.student">
	SELECT STU_NO
		 , (SELECT MEM_NAME FROM MEMBER WHERE MEM_NO = S.MEM_NO) AS MEM_NAME
		 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = S.COLL_NO) AS COLL_NO
		 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO = S.DEPT_NO) AS DEPT_NO
		 , STU_STATUS
		 , (SELECT MEM_TELL FROM MEMBER WHERE MEM_NO = S.MEM_NO)AS MEM_TELL
		 , (SELECT TO_CHAR(MEM_BIRTH, 'YYYY"년"MM"월"DD"일"') FROM MEMBER WHERE MEM_NO = S.MEM_NO) AS MEM_BIRTH
		 , (SELECT TH_CHAR(PROB_DATE, 'YYYY"년"MM"월"DD"일"') FROM STATUS_INFO WHERE STU_NO = S.STU_NO)AS PROB_DATE
		 , (SELECT PROB_REASON FROM STATUS_INFO WHERE STU_NO = S.STU_NO)AS PROB_REASON
		 , (TO_CHAR(STU_YEAR)||'학년'||' '||TO_CHAR(STU_SEM)||'학기')AS STU_YEAR
		 , MEM_NO
	FROM STU S
	WHERE STU_N0 = #{stuNo}
</select>

<!-- by수경 학사경고 승인 시 학사경고 테이블에 넣을 데이터 -->
<insert id="insertProbation">

<selectKey resultType="String" keyProperty="probNo" order="BEFORE">
SELECT 'PROB_'|| LPAD(NVL(MAX(TO_NUMBER(SUBSTR(PROB_NO,6))), 0)+1, 3, 0) 
FROM ACADEMIC PROBATION

</selectKey>
	
	INSERT INTO ACADEMIC PROBATION(PROB_NO
								 , STU_NO
								 , PROB_REASON
								 , SEM_NO
								 , MEM_NO 	
						)VALUES( #{probNo}
							   , #{stuNo}
							   , #{probReason}
							   , #{semNo}
							   , #{memNo}
	)

</insert>

<!--by수경 statusInfo에 데이터 삽입하기 -->
<insert id="insertStatusInfo">

<selectKey resultType="String" keyProperty="statusNo" order="BEFORE">
SELECT 'STATUS_NO_'|| LPAD(NVL(MAX(TO_NUMBER(SUBSTR(STATUS_NO,11))), 0)+1, 3, 0) 
FROM STATUS_INFO
</selectKey>
	INSERT INTO STATUS_INFO( STATUS_NO
						   , STU_NO
						   , NOW_STATUS
						   , AFTER_STATUS
						   , ING_STATUS
				) VALUES( #{statusNo}
						, #{stuNo}
						, #{nowStatus}
						, #{afterStatus}
						, #{ingStatus}
	)

</insert>







		

</mapper>