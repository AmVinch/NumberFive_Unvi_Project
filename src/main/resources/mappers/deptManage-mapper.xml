<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<!--by수경 학생의 휴학, 복학, 전과 복수전공 신청 및 관리자 승인을 위한 mapper입니다.-->
<!--by수경 deptManage mapper입니다.  -->
<mapper namespace="deptManageMapper">

<resultMap type="kh.study.NF.emp.vo.DeptManageVO" id="deptManage">
<id column="APPLY_NO" property="applyNo"/>
<result column="STU_NO" property="stuNo"/>
<result column="APPLY_CODE" property="applyCode"/>
<result column="APPLY_DATE" property="applyDate"/>
<result column="APPLY_REASON" property="applyReason"/>
<result column="APPROVAL_DATE" property="approvalDate"/>
<result column="PROCESS_STATUS" property="processStatus"/>
<result column="FROM_COLL" property="fromColl"/>
<result column="FROM_DEPT" property="fromDept"/>
<result column="TO_COLL" property="toColl"/>
<result column="TO_DEPT" property="toDept"/>
<result column="DOUBLE_MAJOR_COLL" property="doubleMajorColl"/>
<result column="DOUBLE_MAJOR_DEPT" property="doubleMajorDept"/>
<result column="STU_YEAR" property="stuYear"/>
<result column="STU_SEM" property="stuSem"/>
<result column="MEM_NAME" property="memName"/>

</resultMap>

<!--by수경 학생의 복학신청 접수하기-->
<insert id="applyReturnUniv">

<selectKey resultType="String" keyProperty="applyNo" order="BEFORE">

SELECT 'APPLY_'|| LPAD(NVL(MAX(TO_NUMBER(SUBSTR(APPLY_NO,7))), 0)+1, 3, 0) 
FROM DEPT_MANAGE

</selectKey>

INSERT INTO DEPT_MANAGE(APPLY_NO
						, STU_NO
						, APPLY_CODE
						, FROM_COLL
						, FROM_DEPT
						, STU_YEAR
						, STU_SEM
						, PROCESS_STATUS
				)VALUES(  #{applyNo}
						, #{stuNo}
						, #{applyCode}
						, #{fromColl}
						, #{fromDept}
						, (SELECT STU_YEAR FROM STU WHERE STU_NO = #{stuNo})
						, (SELECT STU_SEM FROM STU WHERE STU_NO = #{stuNo})
						, #{processStatus}
)
</insert>

<!--by수경 학생의 휴학신청 접수하기-->
<insert id="applyTakeOffUniv">

<selectKey resultType="String" keyProperty="applyNo" order="BEFORE">
SELECT 'APPLY_'|| LPAD(NVL(MAX(TO_NUMBER(SUBSTR(APPLY_NO,7))), 0)+1, 3, 0) FROM DEPT_MANAGE
</selectKey>

INSERT INTO DEPT_MANAGE(APPLY_NO
						, STU_NO
						, APPLY_CODE
						, APPLY_REASON
						, FROM_COLL
						, FROM_DEPT
						, STU_YEAR
						, STU_SEM
						, PROCESS_STATUS
				)VALUES(  #{applyNo}
						, #{stuNo}
						, #{applyCode}
						, #{applyReason}
						, #{fromColl}
						, #{fromDept}
						, (SELECT STU_YEAR FROM STU WHERE STU_NO = #{stuNo})
						, (SELECT STU_SEM FROM STU WHERE STU_NO = #{stuNo})
						, #{processStatus}
)
</insert>


<!--by수경 학생의 전과신청 접수하기-->
<insert id="applyChangeMajor">

<selectKey resultType="String" keyProperty="applyNo" order="BEFORE">
SELECT 'APPLY_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(APPLY_NO,7))), 0)+1, 3, 0) 
FROM DEPT_MANAGE
</selectKey>

INSERT INTO DEPT_MANAGE(APPLY_NO
						, STU_NO
						, APPLY_CODE
						, APPLY_REASON
						, FROM_COLL
						, FROM_DEPT
						, TO_COLL
						, TO_DEPT
						, STU_YEAR
						, STU_SEM
						, PROCESS_STATUS
				)VALUES(  #{applyNo}
						, #{stuNo} 
						, #{applyCode}
						, #{applyReason}
						, #{fromColl}
						, #{fromDept}
						, #{toColl}
						, #{toDept}
						, (SELECT STU_YEAR FROM STU WHERE STU_NO = #{stuNo})
						, (SELECT STU_SEM FROM STU WHERE STU_NO = #{stuNo})
						, #{processStatus}
)
</insert>


<!--by수경 학생의 복수전공 신청 접수하기-->
<insert id="applyAddMajor">
<selectKey resultType="String" keyProperty="applyNo" order="BEFORE">
SELECT 'APPLY_'|| LPAD(NVL(MAX(TO_NUMBER(SUBSTR(APPLY_NO,7))), 0)+1, 3, 0) FROM DEPT_MANAGE
</selectKey>

INSERT INTO DEPT_MANAGE(APPLY_NO
						, STU_NO
						, APPLY_CODE
						, APPLY_REASON
						, FROM_COLL
						, FROM_DEPT
						, DOUBLE_MAJOR_COLL
						, DOUBLE_MAJOR_DEPT
						, STU_YEAR
						, STU_SEM
						, PROCESS_STATUS
				)VALUES(  #{applyNo}
						, #{stuNo}
						, #{applyCode}
						, #{applyReason}
						, #{fromColl}
						, #{fromDept}
						, #{doubleMajorColl}
						, #{doubleMajorDept}
						, (SELECT STU_YEAR FROM STU WHERE STU_NO = #{stuNo})
						, (SELECT STU_SEM FROM STU WHERE STU_NO = #{stuNo})
						, #{processStatus}
)
</insert>


<!--by수경 학생에게 복학, 휴학, 전과, 복수전공 신청 내역을 보여주는 페이지 목록조회 -->
<select id="stuApplyList" resultMap="deptManage">
SELECT APPLY_NO
	 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = FROM_COLL)AS FROM_COLL
	 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO = FROM_DEPT)AS FROM_DEPT
	 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = TO_COLL) AS TO_COLL
	 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO =TO_DEPT) AS TO_DEPT
	 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = DOUBLE_MAJOR_COLL) AS DOUBLE_MAJOR_COLL
	 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO = DOUBLE_MAJOR_DEPT) AS DOUBLE_MAJOR_DEPT
	 , APPLY_CODE
	 , TO_CHAR(APPLY_DATE, 'YYYY"년"MM"월"DD"일"')AS APPLY_DATE
	 , APPROVAL_DATE
	 , DECODE(PROCESS_STATUS, 'waiting','접수완료','accept','승인완료')AS PROCESS_STATUS
FROM DEPT_MANAGE
WHERE STU_NO = #{stuNo}
	 
</select>

<!--by수경 관리자에게 학생의 복학, 휴학, 전과, 복수전공 신청 목록 보여주는 페이지-->
<select id="applyList" resultMap="deptManage">
SELECT APPLY_NO
	 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = FROM_COLL)AS FROM_COLL
	 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO = FROM_DEPT)AS FROM_DEPT
	 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = TO_COLL) AS TO_COLL
	 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO =TO_DEPT) AS TO_DEPT
	 , (SELECT COLL_NAME FROM COLLEAGE WHERE COLL_NO = DOUBLE_MAJOR_COLL)AS DOUBLE_MAJOR_COLL
	 , (SELECT DEPT_NAME FROM DEPT WHERE DEPT_NO = DOUBLE_MAJOR_DEPT)AS DOUBLE_MAJOR_DEPT
	 , APPLY_CODE
	 , TO_CHAR(APPLY_DATE, 'YYYY"년"MM"월"DD"일"')AS APPLY_DATE
	 , APPROVAL_DATE
	 , PROCESS_STATUS
	 , STU_NO
	 , (SELECT TO_CHAR(STU_YEAR)||'학년'||' '||TO_CHAR(STU_SEM)||'학기'FROM DEPT_MANAGE WHERE APPLY_NO = D.APPLY_NO)AS STU_YEAR 
	 , (SELECT MEM_NAME FROM MEMBER WHERE MEM_NO =
	 								(SELECT MEM_NO FROM STU WHERE STU_NO = D.STU_NO))AS MEM_NAME
FROM DEPT_MANAGE D

</select>

<!--by수경 학생이 복학, 휴학, 전과, 복수전공 신청 시 이미 신청내역 있는지 확인 -->
<select id="checkApply" resultMap="deptManage">
	SELECT APPLY_NO 
		 , STU_NO
		 , APPLY_CODE
		 , STU_YEAR
		 , STU_SEM
	FROM DEPT_MANAGE
	WHERE STU_NO = #{stuNo}
	AND APPLY_CODE = #{applyCode}
</select>

<!--by수경 승인대기/승인완료 단일승인(라디오 값) -->
<update id="changeStatus">
	UPDATE DEPT_MANAGE 
	SET PROCESS_STATUS = #{processStatus}
		, APPROVAL_DATE = #{approvalDate} 
	WHERE APPLY_NO = #{applyNo} 
</update>

<!-- by수경 복학/휴학신청 일괄승인 -->
<update id="comebackTakeOffAllAccept">
	UPDATE DEPT_MANAGE
	SET APPROVAL_DATE = #{approvalDate}
		, PROCESS_STATUS = #{processStatus}
	WHERE APPLY_NO IN
	<foreach collection="applyNoList" item="applyNo" separator="," open="(" close=")" >
       #{applyNo}
  	</foreach> 

</update>


</mapper>
